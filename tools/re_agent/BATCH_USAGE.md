# Batch Processing Usage Guide

## Overview

The batch processing agent is designed to process all your reverse engineering work in one fell swoop. Instead of chatting with the agent, you feed it your logs and code, and it produces corrected implementations.

## Primary Use Case: Full Project Review

This is what you want - process everything at once:

```bash
cd tools/re_agent

# Set your API key
export OPENAI_API_KEY="your-key-here"

# Process the entire OpenIMP project
python full_review_workflow.py --project-dir /home/matteius/openimp
```

### What It Does

1. **Scans for logs** - Finds all `*.log` files in your project
2. **Extracts decompilations** - Pulls out function decompilations from logs
3. **Reviews source files** - Scans all `src/**/*.c` files for unsafe patterns
4. **Analyzes each function** - Uses GPT-4 to:
   - Extract struct offsets from decompilations
   - Identify unsafe pointer arithmetic
   - Generate safe struct definitions
   - Create corrected implementations
5. **Consolidates results** - Produces:
   - `review_report.txt` - Comprehensive findings
   - `all_structs.h` - All struct definitions
   - `implementations/*.c` - Corrected function implementations
   - `review_results.json` - Machine-readable results

### Output Structure

```
full_review_output/
├── review_report.txt          # Human-readable report
├── review_results.json        # JSON data for automation
├── all_structs.h              # Consolidated struct definitions
├── function_index.json        # List of all functions
└── implementations/           # Corrected implementations
    ├── IMP_Encoder_CreateGroup.c
    ├── IMP_Encoder_GetStream.c
    └── ...
```

## Targeted Processing

### Process Specific Logs and Sources

```bash
# Process specific files
python full_review_workflow.py \
  --logs "logs/encoder_session.log" "logs/system_session.log" \
  --sources "src/imp/imp_encoder.c" "src/imp/imp_system.c" \
  --output encoder_review
```

### Review a Single File

```bash
# Review one source file for issues
python batch_review.py --review-file src/imp/imp_encoder.c --output encoder_issues
```

This will:
- Find unsafe pointer arithmetic
- Check for missing offset documentation
- Identify good practices (memcpy usage)
- Generate a report

### Process a Log File

```bash
# Extract and implement functions from a log
python batch_review.py --input logs/my_session.log --output log_analysis
```

The agent will:
- Extract decompilations from the log
- Analyze each function
- Generate struct definitions
- Create safe implementations

## Auto-Decompile Missing Functions

If you have Binary Ninja MCP running with your binaries:

```bash
# Decompile specific functions and generate implementations
python full_review_workflow.py \
  --auto-decompile \
  --functions "IMP_Encoder_CreateGroup,IMP_Encoder_DestroyGroup,IMP_Encoder_CreateChn" \
  --binary port_9009 \
  --output auto_decompiled
```

## Understanding the Output

### Review Report

The `review_report.txt` contains:

```
================================================================================
MIPS REVERSE ENGINEERING BATCH REVIEW REPORT
================================================================================

1. IMP_Encoder_CreateGroup
--------------------------------------------------------------------------------

ISSUES FOUND:
  • UNSAFE: Direct pointer arithmetic found - must use typed struct access
  • Missing offset documentation in struct definitions

STRUCT DEFINITIONS:
typedef struct EncoderGroup {
    int32_t grp_num; /* 0x0000: Group number */
    int32_t state; /* 0x0004: Group state */
    uint8_t padding_0008[220]; /* 0x0008 */
    sem_t sem_e4; /* 0x00e4: Semaphore for signaling */
    ...
} EncoderGroup;

SAFE ACCESS PATTERNS:
  • Use typed struct access: struct->member
  • Use memcpy() for unknown layouts

CORRECTED IMPLEMENTATION:
[Safe implementation code here]

NOTES: [AI analysis and recommendations]
```

### Struct Definitions

The `all_structs.h` file contains all discovered structs:

```c
/* Auto-generated struct definitions */
/* Generated by MIPS RE Agent */

#ifndef OPENIMP_STRUCTS_H
#define OPENIMP_STRUCTS_H

#include <stdint.h>
#include <pthread.h>
#include <semaphore.h>

typedef struct EncoderGroup {
    int32_t grp_num; /* 0x0000 */
    int32_t state; /* 0x0004 */
    ...
} EncoderGroup;

typedef struct EncChannel {
    int32_t chn_id; /* 0x0000 */
    uint8_t started; /* 0x03ac */
    ...
} EncChannel;

#endif /* OPENIMP_STRUCTS_H */
```

### Implementations

Each corrected implementation in `implementations/` is a complete, safe version:

```c
// implementations/IMP_Encoder_CreateGroup.c

int32_t IMP_Encoder_CreateGroup(int32_t grpNum) {
    EncoderGroup *group = malloc(sizeof(EncoderGroup));
    if (!group) {
        return -1;
    }
    
    // Safe typed access - no pointer arithmetic!
    group->grp_num = grpNum;
    group->state = 0;
    
    // Initialize semaphore at offset 0xe4
    sem_init(&group->sem_e4, 0, 0);
    
    return 0;
}
```

## Workflow Integration

### Typical Workflow

1. **Do your reverse engineering work** - Use Binary Ninja, take notes, save logs
2. **Run the batch processor** - Let the agent review everything
3. **Review the report** - Check findings and recommendations
4. **Apply corrections** - Use the generated implementations
5. **Iterate** - Run again as you discover more

### Example Session

```bash
# After a day of reverse engineering...
cd tools/re_agent

# Process everything
python full_review_workflow.py --project-dir /home/matteius/openimp

# Review findings
less full_review_output/review_report.txt

# Check a specific struct
grep -A 20 "typedef struct EncChannel" full_review_output/all_structs.h

# Copy corrected implementation
cp full_review_output/implementations/IMP_Encoder_CreateGroup.c ../src/imp/

# Commit the improvements
git add src/imp/IMP_Encoder_CreateGroup.c
git commit -m "Apply safe struct access patterns from RE agent review"
```

## Tips

1. **Run frequently** - The agent learns from your logs, so run it after each RE session
2. **Review before applying** - Always review the generated code before using it
3. **Keep logs** - The more context in your logs, the better the analysis
4. **Document offsets** - The agent preserves offset comments for verification
5. **Check for patterns** - Look for repeated issues across functions

## Advanced: Custom Processing

You can also use the Python API directly:

```python
from batch_review import BatchReviewAgent

agent = BatchReviewAgent(output_dir="my_results")

# Process a log
agent.process_log_file("logs/my_session.log")

# Review a source file
agent.review_source_file("src/imp/imp_encoder.c")

# Generate report
print(agent.generate_report())

# Save everything
agent.save_results()
```

## Troubleshooting

**No decompilations found in log:**
- Make sure your log contains function code
- Check the log format matches expected patterns
- Try adding more context around decompilations

**Missing struct definitions:**
- Ensure decompilations show struct member accesses
- Add offset comments in your code
- Provide more complete decompilations

**API errors:**
- Check OPENAI_API_KEY is set
- Verify you have API credits
- Check network connectivity

## Next Steps

After running the batch processor:

1. Review `review_report.txt` for all findings
2. Check `all_structs.h` for struct definitions
3. Review implementations in `implementations/`
4. Apply corrections to your codebase
5. Run tests to verify correctness
6. Iterate as needed

